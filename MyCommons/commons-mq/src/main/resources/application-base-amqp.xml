<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:rabbit="http://www.springframework.org/schema/rabbit"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                http://www.springframework.org/schema/beans/spring-beans.xsd
                http://www.springframework.org/schema/rabbit
                http://www.springframework.org/schema/rabbit/spring-rabbit.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">
    <!--配置扫描的controller-->
    <context:component-scan base-package="com.apollo.commons.mq.utils.converter"/>
    <!-- 连接服务配置  -->
    <rabbit:connection-factory id="connectionFactory" addresses="${amqp.host}"
                               username="${amqp.username}"
                               password="${amqp.password}"/>

    <rabbit:admin connection-factory="connectionFactory"/>

    <!-- spring template声明-->
    <rabbit:template id="rabbitTemplate"
                     exchange="st.topic.default"
                     connection-factory="connectionFactory"
                     message-converter="fastJsonMessageConverter"/>

    <!--死信队列-->
    <rabbit:queue name="dlq"/>

    <rabbit:topic-exchange name="dlx">
        <rabbit:bindings>
            <rabbit:binding queue="dlq" pattern="tl.#"/>
        </rabbit:bindings>
    </rabbit:topic-exchange>

    <!--超时队列-->
    <rabbit:queue name="timeout_queue">
        <rabbit:queue-arguments>
            <entry key="x-dead-letter-exchange" value="dlx"/>
            <entry key="x-dead-letter-routing-key" value="tl.timeout"/>
        </rabbit:queue-arguments>
    </rabbit:queue>

    <rabbit:direct-exchange name="timeout_exchange">
        <rabbit:bindings>
            <rabbit:binding queue="timeout_queue" key="timeout.queue"/>
        </rabbit:bindings>
    </rabbit:direct-exchange>

    <rabbit:queue name="logstash"/>

    <rabbit:listener-container connection-factory="connectionFactory"
                               advice-chain="interceptors"
                               acknowledge="auto"
                               message-converter="fastJsonMessageConverter">
        <rabbit:listener ref="dlqListener" queues="dlq"/>
    </rabbit:listener-container>

    <util:list id="interceptors">
        <bean id="retryInterceptor" class="org.springframework.amqp.rabbit.config.StatelessRetryOperationsInterceptorFactoryBean">
            <property name="retryOperations">
                <bean class="org.springframework.retry.support.RetryTemplate">
                    <property name="retryPolicy">
                        <bean class="org.springframework.retry.policy.NeverRetryPolicy"/>
                    </property>
                </bean>
            </property>
        </bean>
    </util:list>

    <bean id="dlqListener" class="com.apollo.commons.mq.consumer.DLQListener">
        <constructor-arg index="0" ref="rabbitTemplate"/>
        <constructor-arg index="1" value="timeout_exchange"/>
        <constructor-arg index="2" value="timeout.queue"/>
        <constructor-arg index="3" value="${amqp.initial.interval:2000}"/>
        <constructor-arg index="4" value="${amqp.max.retry:6}"/>
    </bean>

</beans>